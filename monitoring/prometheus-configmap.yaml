apiVersion: v1
kind: ConfigMap
metadata:
 name: prometheus-cm0
 namespace: monitoring
 labels:
   io.kompose.service: prometheus
 annotations:
   use-subpath: "true"
data:
 prometheus.yml: |
   global:
    scrape_interval: 15s
    evaluation_interval: 15s
  scrape_configs:
    # ----------------------------------
    # Prometheus self-metrics
    # ----------------------------------
    - job_name: "prometheus"
      static_configs:
        - targets: ["prometheus:9090"]
    # ----------------------------------
    # Kubelet metrics (/metrics)
    # ----------------------------------
    - job_name: "kubelet"
      scheme: https
      kubernetes_sd_configs:
        - role: node
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      tls_config:
        insecure_skip_verify: true
      relabel_configs:
        - action: labelmap
          regex: __meta_kubernetes_node_label_(.+)
        - target_label: __address__
          replacement: kubernetes.default.svc:443
        - source_labels: [__meta_kubernetes_node_name]
          target_label: __metrics_path__
          replacement: /api/v1/nodes/$1/proxy/metrics
    # ----------------------------------
    # cAdvisor metrics (/metrics/cadvisor)
    # ----------------------------------
    - job_name: "kubelet-cadvisor"
      scheme: https
      kubernetes_sd_configs:
        - role: node
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      tls_config:
        insecure_skip_verify: true
      relabel_configs:
        - action: labelmap
          regex: __meta_kubernetes_node_label_(.+)
        - target_label: __address__
          replacement: kubernetes.default.svc:443
        - source_labels: [__meta_kubernetes_node_name]
          target_label: __metrics_path__
          replacement: /api/v1/nodes/$1/proxy/metrics/cadvisor
    # ----------------------------------
    # Node Exporter
    # ----------------------------------
    - job_name: "node-exporter"
      kubernetes_sd_configs:
        - role: endpoints
      relabel_configs:
        - source_labels: [__meta_kubernetes_service_name]
          action: keep
          regex: node-exporter
    # ----------------------------------
    # Trivy Operator metrics
    # ----------------------------------
    - job_name: "trivy-operator"
      static_configs:
        - targets:
            - trivy-operator.trivy-system.svc.cluster.local:8080
    # ----------------------------------
    # Kube State Metrics
    # ----------------------------------
    - job_name: "kube-state-metrics"
      honor_labels: true
      static_configs:
        - targets:
            - kube-state-metrics.monitoring.svc.cluster.local:8080
    # ----------------------------------
    # Trivy CVE Exporter (Python)
    # ----------------------------------
    - job_name: "trivy-cve-exporter"
      kubernetes_sd_configs:
        - role: endpoints
      relabel_configs:
        # Keep only monitoring namespace
        - source_labels: [__meta_kubernetes_namespace]
          action: keep
          regex: monitoring
        # Keep only trivy-cve-exporter service
        - source_labels: [__meta_kubernetes_service_name]
          action: keep
          regex: trivy-cve-exporter
        # Keep only the metrics port
        - source_labels: [__meta_kubernetes_endpoint_port_name]
          action: keep
          regex: metrics
